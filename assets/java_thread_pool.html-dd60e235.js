import{_ as s,p as t,q as e,R as p,a1 as n}from"./framework-96b046e1.js";const o={},c=n('<h1 id="线程池" tabindex="-1"><a class="header-anchor" href="#线程池" aria-hidden="true">#</a> 线程池</h1><h2 id="线程池简介" tabindex="-1"><a class="header-anchor" href="#线程池简介" aria-hidden="true">#</a> 线程池简介</h2><p>线程池（ThreadPool） 是一种基于池化思想管理线程的工具。线程池维护多个线程，等待监督和管理分配可并 发执行的任务。看过new Thread源码后我们发现，频繁创建线程销毁线程的开销很大，会降低系统整体性能。</p><h2 id="优点" tabindex="-1"><a class="header-anchor" href="#优点" aria-hidden="true">#</a> 优点</h2><p>➢ 降低资源消耗：通过线程池复用线程，降低创建线程和释放线程的损耗<br> ➢ 提高响应速度：任务到达时，无需等待即刻运行<br> ➢ 提高线程的可管理性：使用线程池可以进行统一的线程分配、调优和监控<br> ➢ 提供可扩展性：线程池具备可扩展性，研发人员可以向其中增加各种功能，比如：延时、定时、监控等</p><h2 id="使用场景" tabindex="-1"><a class="header-anchor" href="#使用场景" aria-hidden="true">#</a> 使用场景</h2><p>➢ 连接池：预先申请数据库连接，提升申请连接的速度，降低系统的开销（跨网络应用都需要线程池）<br> ➢ 线程隔离：服务器接收大量请求，使用线程池来进行隔离处理<br> ➢ 开发中，如需创建5以上线程，就可以考虑用线程池</p><h2 id="线程池的核心参数" tabindex="-1"><a class="header-anchor" href="#线程池的核心参数" aria-hidden="true">#</a> 线程池的核心参数</h2><p>参数详解：<br> ➢ corePoolSize：核心线程数，可以理解为空闲线程数，即便线程空闲（Idle），也不会回收<br> ➢ maxPoolSize ：最大线程数，线程池可以容纳线程的上限<br> ➢ keepAliveTime ：线程保持存活的时间，超过核心线程数的线程存活空闲时间超过keepAliveTime后就会被回收<br> ➢ unit: 时间单位<br> ➢ workQueue ：工作队列，直接交换队列SynchronousQueue，无界队列LinkedBlockingQueue ，有界队列 ArrayBlockingQueue<br> ➢ threadFactory：线程工厂，用来创建线程的工厂，线程都是出自于此工厂<br> ➢ Handler：线程无法接收任务时的拒绝策略</p><h2 id="线程池原理" tabindex="-1"><a class="header-anchor" href="#线程池原理" aria-hidden="true">#</a> 线程池原理</h2>',10),i=["src"],u=n(`<p>① 提交任务，如果线程数小于corePoolSize即使其他线程处于空闲状态，也会创建一个新线程来运行任务<br> ② 如果线程数大于corePoolSize，但少于maxPoolSize，将任务放入工作队列<br> ③ 如果队列已满，并且线程数小于maxPoolSize，则创建一个新线程来运行任务。<br> ④ 如果队列已满，并且线程数大于或等于maxPoolSize，则拒绝该任务。</p><h2 id="自动创建线程" tabindex="-1"><a class="header-anchor" href="#自动创建线程" aria-hidden="true">#</a> 自动创建线程</h2><p>四种：<br> ①newFixedThreadPool：固定数量线程池，无界任务阻塞队列<br> ②newSingleThreadExecutor ：一个线程的线程池，无界任务阻塞队列<br> ③newCachedThreadPool ：可缓存线程的无界线程池，可以自动回收多余线程<br> ④newScheduledThreadPool ：定时任务线程池</p><h2 id="手动创建线程" tabindex="-1"><a class="header-anchor" href="#手动创建线程" aria-hidden="true">#</a> 手动创建线程</h2><p>如何设置线程池大小？<br> ➢ CPU密集型：线程数量不能太多，可以设置为与相当于CPU核数-Runtime.getRuntime().availableProcessors()<br> ➢ IO密集型：IO密集型CPU使用率不高，可以设置的线程数量多一些，可以设置为CPU核心数的2倍<br> 拒绝策略：<br> ➢ 拒绝时机：①最大线程和工作队列有限且已经饱和，②Executor关闭时<br> ➢ 抛异常策略：AbortPolicy，说明任务没有提交成功<br> ➢ 不做处理策略：DiscardPolicy，默默丢弃任务，不做处理<br> ➢ 丢弃老任务策略：DiscardOldestPolicy，将队列中存在最久的任务给丢弃<br> ➢ 自产自销策略：CallerRunsPolicy，那个线程提交任务就由那个线程负责运行</p><h2 id="示例代码" tabindex="-1"><a class="header-anchor" href="#示例代码" aria-hidden="true">#</a> 示例代码</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>xt<span class="token punctuation">.</span>blog<span class="token punctuation">.</span>web<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolTaskExecutor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Executor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutor</span></span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 功能描述:自定义线程池
 *
 * <span class="token keyword">@author</span> wdl
 * <span class="token keyword">@date</span> 2022/12/31 - 18:50
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">&quot;taskExecutor&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">taskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadPoolTaskExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置核心线程数</span>
        executor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置最大线程数</span>
        executor<span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//配置队列大小</span>
        executor<span class="token punctuation">.</span><span class="token function">setQueueCapacity</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置线程空闲时间，当超过核心线程之外的线程在空闲到达之后会被销毁（秒）</span>
        executor<span class="token punctuation">.</span><span class="token function">setKeepAliveSeconds</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置默认线程名称</span>
        executor<span class="token punctuation">.</span><span class="token function">setThreadNamePrefix</span><span class="token punctuation">(</span><span class="token string">&quot;ThreadExecutor&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 等待所有任务结束后再关闭线程池</span>
        executor<span class="token punctuation">.</span><span class="token function">setWaitForTasksToCompleteOnShutdown</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//拒绝策略</span>
        executor<span class="token punctuation">.</span><span class="token function">setRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//执行初始化</span>
        executor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> executor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
     * 数据看板初始化
     *
     * <span class="token keyword">@param</span> <span class="token parameter">userId</span>
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/initialization&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InitializationDataBoardVo</span><span class="token punctuation">&gt;</span></span> <span class="token function">initializationDataBoard</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> userId
            <span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;selectYear&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> selectYear<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化对象</span>
        <span class="token class-name">InitializationDataBoardVo</span> initializationDataBoardVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InitializationDataBoardVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建线程计数器</span>
        <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 线程执行调用,获取用户信息</span>
        taskExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>dataBoardService<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span>countDownLatch<span class="token punctuation">,</span> initializationDataBoardVo<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 线程执行调用,数据看板界面月度注册的用户排行情况</span>
        taskExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>dataBoardService<span class="token punctuation">.</span><span class="token function">getUserRecordData</span><span class="token punctuation">(</span>countDownLatch<span class="token punctuation">,</span> initializationDataBoardVo<span class="token punctuation">,</span> selectYear<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 线程执行调用,数据看板用户数据统计</span>
        taskExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>dataBoardService<span class="token punctuation">.</span><span class="token function">getCountData</span><span class="token punctuation">(</span>countDownLatch<span class="token punctuation">,</span> initializationDataBoardVo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 线程计数器等待全部线程执行完成</span>
        countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>initializationDataBoardVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Runnable</span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token class-name">CountDownLatch</span> countDownLatch<span class="token punctuation">,</span> <span class="token class-name">InitializationDataBoardVo</span> initializationDataBoardVo<span class="token punctuation">,</span> <span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Runnable</span> runnable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// feign远程调用到user微服务获取用户信息</span>
                <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">UserInfoVo</span><span class="token punctuation">&gt;</span></span> userInfoVoResult <span class="token operator">=</span> userFeignService<span class="token punctuation">.</span><span class="token function">getUserInfoByUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                initializationDataBoardVo<span class="token punctuation">.</span><span class="token function">setUserInfoVo</span><span class="token punctuation">(</span>userInfoVoResult<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;get userInfo error message:{}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// 线程计数器减一</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> runnable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="threadlocal" tabindex="-1"><a class="header-anchor" href="#threadlocal" aria-hidden="true">#</a> ThreadLocal</h2><p>ThreadLocal是线程本地变量类，在多线程并执行过程中，将变量存储在ThreadLocal中，每个线程中都有独立的变量，因 此不会出现线程安全问题。</p><p>举例：<br> ➢ 解决线程安全问题：每个线程绑定一个数据库连接，避免多个线程访问同一个数据库连接：SqlSession<br> ➢ 跨函数参数传递：同一个线程，跨类，跨方法传递参数时可以使用ThreadLocal，每个线程绑定一个Token/Session</p><h2 id="threadlocal底层原理" tabindex="-1"><a class="header-anchor" href="#threadlocal底层原理" aria-hidden="true">#</a> ThreadLocal底层原理</h2><p>JDK1.8之前：ThreadLocal是Map所有线程拥有同一个，Key为thread，Value为具体值<br> JDK1.8：ThreadLocal依旧是Map，但一个线程一个ThreadLocalMap，key为ThreadLocal，Value为具体值</p><h2 id="future与futuretask" tabindex="-1"><a class="header-anchor" href="#future与futuretask" aria-hidden="true">#</a> Future与FutureTask</h2><h3 id="future主要方法" tabindex="-1"><a class="header-anchor" href="#future主要方法" aria-hidden="true">#</a> Future主要方法</h3><p>➢ get()：方法返回结果取决于Callable任务执行的状态，任务有五种状态<br> ① 正常完成：get立刻返回结果<br> ② 尚未完成：还没开始或进行中的状态，get将阻塞直到任务完成<br> ③ 抛出异常：get会抛出ExecutionException<br> ④ 被取消： get会抛出CancellationException<br> ⑤ 超时：设置超时时间，时间到了还没结果，会抛出TimeoutException<br> ➢ get(timeout,TimeUnit)：设置任务完成时间，没到则抛异常<br> ➢ cancel()：取消任务时，有三种情况<br> ① 如果这个任务还没开始，任务会被取消，返回true<br> ② 如果任务已经完成或已取消，返回false<br> ③ 如果任务已经开始，则方法不会直接取消任务，而会判断是否可以取消，如果可以才会发出中断信号<br> ➢ isDone() ：判断是否执行完成<br> ➢ isCancelled() ： 判断是否被取消</p><h3 id="future与futuretask案例" tabindex="-1"><a class="header-anchor" href="#future与futuretask案例" aria-hidden="true">#</a> Future与FutureTask案例</h3><p>Future用法01-用线程池submit方法提交任务，返回值Future任务结果<br> ➢ 用线程池提交任务，线程池会立即返回一个空的Future容器<br> ➢ 当线程的任务执行完成，线程池会将该任务执行结果填入Future中<br> ➢ 此时就可以从Future获取执行结果<br> Future用法02-用FutureTask来封装任务，获取Future任务的结果<br> ➢ 用FutureTask包装任务，FutureTask是Future和Runnable接口的实现类<br> ➢ 可以使用new Thread().start()或线程池执行FutureTask<br> ➢ 任务执行完成，可以从FutureTask中获取执行结果</p>`,19);function l(a,r){return t(),e("div",null,[c,p("img",{src:a.$withBase("/images/thread/31.png"),alt:"jvm"},null,8,i),u])}const k=s(o,[["render",l],["__file","java_thread_pool.html.vue"]]);export{k as default};
